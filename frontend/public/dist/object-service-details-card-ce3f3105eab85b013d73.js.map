{"version":3,"file":"object-service-details-card-ce3f3105eab85b013d73.js","sources":["webpack:///./packages/ceph-storage-plugin/src/selectors/index.ts","webpack:///./packages/noobaa-storage-plugin/src/components/details-card/details-card.tsx","webpack:///./packages/noobaa-storage-plugin/src/utils.ts","webpack:///./public/components/utils/k8s-get-hook.ts"],"sourcesContent":["import * as _ from 'lodash';\nimport { Alert } from '@console/internal/components/monitoring';\nimport { K8sResourceKind } from '@console/internal/module/k8s';\nimport { FirehoseResult, convertToBaseValue } from '@console/internal/components/utils';\nimport { cephStorageProvisioners } from '@console/shared/src/utils';\nimport { OCS_OPERATOR } from '../constants';\n\nexport const cephStorageLabel = 'cluster.ocs.openshift.io/openshift-storage';\n\nconst enum status {\n  BOUND = 'Bound',\n  AVAILABLE = 'Available',\n}\nexport const filterCephAlerts = (alerts: Alert[]): Alert[] =>\n  alerts.filter((alert) => _.get(alert, 'annotations.storage_type') === 'ceph');\n\nexport const getCephPVs = (pvsData: K8sResourceKind[] = []): K8sResourceKind[] =>\n  pvsData.filter((pv) => {\n    return cephStorageProvisioners.some((provisioner: string) =>\n      _.get(pv, 'metadata.annotations[\"pv.kubernetes.io/provisioned-by\"]', '').includes(\n        provisioner,\n      ),\n    );\n  });\n\nconst getPVStorageClass = (pv: K8sResourceKind) => _.get(pv, 'spec.storageClassName');\nconst getStorageClassName = (pvc: K8sResourceKind) =>\n  _.get(pvc, ['metadata', 'annotations', 'volume.beta.kubernetes.io/storage-class']) ||\n  _.get(pvc, 'spec.storageClassName');\nconst isBound = (pvc: K8sResourceKind) => pvc.status.phase === status.BOUND;\n\nexport const getCephPVCs = (\n  cephSCNames: string[] = [],\n  pvcsData: K8sResourceKind[] = [],\n  pvsData: K8sResourceKind[] = [],\n): K8sResourceKind[] => {\n  const cephPVs = getCephPVs(pvsData);\n  const cephSCNameSet = new Set<string>([...cephSCNames, ...cephPVs.map(getPVStorageClass)]);\n  const cephBoundPVCUIDSet = new Set<string>(_.map(cephPVs, 'spec.claimRef.uid'));\n  // If the PVC is bound use claim uid(links PVC to PV) else storage class to verify it's provisioned by ceph.\n  return pvcsData.filter((pvc: K8sResourceKind) =>\n    isBound(pvc)\n      ? cephBoundPVCUIDSet.has(pvc.metadata.uid)\n      : cephSCNameSet.has(getStorageClassName(pvc)),\n  );\n};\n\nexport const getCephNodes = (nodesData: K8sResourceKind[] = []): K8sResourceKind[] =>\n  nodesData.filter((node) => _.keys(_.get(node, 'metadata.labels')).includes(cephStorageLabel));\n\nexport const getCephSC = (scData: K8sResourceKind[]): K8sResourceKind[] =>\n  scData.filter((sc) => {\n    return cephStorageProvisioners.some((provisioner: string) =>\n      _.get(sc, 'provisioner', '').includes(provisioner),\n    );\n  });\n\nexport const getOCSVersion = (items: FirehoseResult): string => {\n  const itemsData: K8sResourceKind[] = _.get(items, 'data');\n  const operator: K8sResourceKind = _.find(\n    itemsData,\n    (item) => _.get(item, 'spec.name') === OCS_OPERATOR,\n  );\n  return _.get(operator, 'status.installedCSV');\n};\n\nexport const calcPVsCapacity = (pvs: K8sResourceKind[]): number =>\n  pvs.reduce((sum, pv) => {\n    const storage = Number(convertToBaseValue(pv.spec.capacity.storage));\n    return sum + storage;\n  }, 0);\n\nexport const getSCAvailablePVs = (pvsData: K8sResourceKind[], sc: string): K8sResourceKind[] =>\n  pvsData.filter((pv) => getPVStorageClass(pv) === sc && pv.status.phase === status.AVAILABLE);\n","import * as React from 'react';\nimport * as _ from 'lodash';\nimport { getInfrastructurePlatform } from '@console/shared';\nimport DashboardCard from '@console/shared/src/components/dashboard/dashboard-card/DashboardCard';\nimport DashboardCardBody from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardBody';\nimport DashboardCardHeader from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardHeader';\nimport DashboardCardTitle from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardTitle';\nimport DetailsBody from '@console/shared/src/components/dashboard/details-card/DetailsBody';\nimport DetailItem from '@console/shared/src/components/dashboard/details-card/DetailItem';\nimport {\n  DashboardItemProps,\n  withDashboardResources,\n} from '@console/internal/components/dashboard/with-dashboard-resources';\nimport { FirehoseResource, ExternalLink, FirehoseResult } from '@console/internal/components/utils';\nimport { InfrastructureModel } from '@console/internal/models/index';\nimport { SubscriptionModel } from '@console/operator-lifecycle-manager/src/models';\nimport { referenceForModel, K8sResourceKind } from '@console/internal/module/k8s';\nimport { PrometheusResponse } from '@console/internal/components/graphs';\nimport { getOCSVersion } from '@console/ceph-storage-plugin/src/selectors';\nimport { useK8sGet } from '@console/internal/components/utils/k8s-get-hook';\nimport { getMetric } from '../../utils';\n\nconst NOOBAA_SYSTEM_NAME_QUERY = 'NooBaa_system_info';\nconst NOOBAA_DASHBOARD_LINK_QUERY = 'NooBaa_system_links';\n\nconst SubscriptionResource: FirehoseResource = {\n  kind: referenceForModel(SubscriptionModel),\n  namespaced: false,\n  prop: 'subscription',\n  isList: true,\n};\n\nexport const ObjectServiceDetailsCard: React.FC<DashboardItemProps> = ({\n  watchK8sResource,\n  stopWatchK8sResource,\n  watchPrometheus,\n  stopWatchPrometheusQuery,\n  prometheusResults,\n  resources,\n}) => {\n  const [infrastructure, infrastructureLoaded, infrastructureError] = useK8sGet<K8sResourceKind>(\n    InfrastructureModel,\n    'cluster',\n  );\n  React.useEffect(() => {\n    watchK8sResource(SubscriptionResource);\n    watchPrometheus(NOOBAA_SYSTEM_NAME_QUERY);\n    watchPrometheus(NOOBAA_DASHBOARD_LINK_QUERY);\n    return () => {\n      stopWatchK8sResource(SubscriptionResource);\n      stopWatchPrometheusQuery(NOOBAA_SYSTEM_NAME_QUERY);\n      stopWatchPrometheusQuery(NOOBAA_DASHBOARD_LINK_QUERY);\n    };\n  }, [watchK8sResource, stopWatchK8sResource, watchPrometheus, stopWatchPrometheusQuery]);\n\n  const systemResult = prometheusResults.getIn([\n    NOOBAA_SYSTEM_NAME_QUERY,\n    'data',\n  ]) as PrometheusResponse;\n  const dashboardLinkResult = prometheusResults.getIn([\n    NOOBAA_DASHBOARD_LINK_QUERY,\n    'data',\n  ]) as PrometheusResponse;\n  const systemLoadError = prometheusResults.getIn([NOOBAA_SYSTEM_NAME_QUERY, 'loadError']);\n  const dashboardLinkLoadError = prometheusResults.getIn([\n    NOOBAA_DASHBOARD_LINK_QUERY,\n    'loadError',\n  ]);\n\n  const systemName = getMetric(systemResult, 'system_name');\n  const systemLink = getMetric(dashboardLinkResult, 'dashboard');\n\n  const infrastructurePlatform = getInfrastructurePlatform(infrastructure);\n\n  const subscription = _.get(resources, 'subscription') as FirehoseResult;\n  const subscriptionLoaded = _.get(subscription, 'loaded');\n  const ocsVersion = getOCSVersion(subscription);\n\n  return (\n    <DashboardCard>\n      <DashboardCardHeader>\n        <DashboardCardTitle>Details</DashboardCardTitle>\n      </DashboardCardHeader>\n      <DashboardCardBody>\n        <DetailsBody>\n          <DetailItem key=\"service_name\" title=\"Service Name\" error={false} isLoading={false}>\n            OpenShift Container Storage (OCS)\n          </DetailItem>\n          <DetailItem\n            key=\"system_name\"\n            title=\"System Name\"\n            isLoading={!systemResult || !dashboardLinkResult}\n            error={systemLoadError || dashboardLinkLoadError || !systemName || !systemLink}\n          >\n            <ExternalLink href={systemLink} text={systemName} />\n          </DetailItem>\n          <DetailItem\n            key=\"provider\"\n            title=\"Provider\"\n            error={!!infrastructureError || (infrastructure && !infrastructurePlatform)}\n            isLoading={!infrastructureLoaded}\n          >\n            {infrastructurePlatform}\n          </DetailItem>\n          <DetailItem\n            key=\"version\"\n            title=\"Version\"\n            isLoading={!subscriptionLoaded}\n            error={subscriptionLoaded && !ocsVersion}\n          >\n            {ocsVersion}\n          </DetailItem>\n        </DetailsBody>\n      </DashboardCardBody>\n    </DashboardCard>\n  );\n};\n\nexport const DetailsCard = withDashboardResources(ObjectServiceDetailsCard);\n","import * as _ from 'lodash';\nimport { Alert } from '@console/internal/components/monitoring';\nimport { PrometheusResponse } from '@console/internal/components/graphs';\nimport { K8sResourceKind } from '@console/internal/module/k8s';\nimport { StorageClass } from '@console/internal/components/storage-class-form';\n\nexport const filterNooBaaAlerts = (alerts: Alert[]): Alert[] =>\n  alerts.filter((alert) => _.get(alert, 'annotations.storage_type') === 'NooBaa');\n\nexport const getGaugeValue = (data) => _.get(data, 'data.result[0].value[1]');\n\nexport const getMetric = (result: PrometheusResponse, metric: string): string =>\n  _.get(result, ['data', 'result', '0', 'metric', metric], null);\n\nexport type PrometheusMetricResult = {\n  metric: { [key: string]: any };\n  value?: [number, string | number];\n};\n\nexport const getPhase = (obj: K8sResourceKind): string => {\n  return _.get(obj, 'status.phase', 'Lost');\n};\n\nexport const isBound = (obj: K8sResourceKind): boolean => getPhase(obj) === 'Bound';\n\nexport const getSCProvisioner = (obj: StorageClass) => obj.provisioner;\n","import * as React from 'react';\nimport { k8sGet, K8sKind, K8sResourceCommon } from '../../module/k8s';\n\nexport const useK8sGet = <R extends K8sResourceCommon = K8sResourceCommon>(\n  kind: K8sKind,\n  name?: string,\n  namespace?: string,\n  opts?: { [k: string]: string },\n): [R, boolean, any] => {\n  const [data, setData] = React.useState<R>();\n  const [loaded, setLoaded] = React.useState(false);\n  const [loadError, setLoadError] = React.useState();\n\n  React.useEffect(() => {\n    const fetch = async () => {\n      try {\n        setLoadError(null);\n        setLoaded(false);\n        setData(null);\n        const resource = await k8sGet(kind, name, namespace, opts);\n        setData(resource);\n      } catch (error) {\n        setLoadError(error);\n      } finally {\n        setLoaded(true);\n      }\n    };\n    fetch();\n  }, [kind, name, namespace, opts]);\n\n  return [data, loaded, loadError];\n};\n"],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAGA;AACA;AACA;AAEA;AAEA;AAAA;AACA;AACA;AACA;AACA;AAGA;AAEA;AAKA;AAEA;AACA;AAEA;AACA;AAEA;AAKA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AAGA;AAEA;AAGA;AAEA;AACA;AACA;AAIA;AACA;AAEA;AAEA;AACA;AACA;AAEA;;;;;;;;;;;;;ACxEA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAIA;AACA;AACA;AACA;AAEA;AACA;AACA;AAEA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AAEA;AAQA;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;AAEA;AAEA;AACA;AACA;AAEA;AAEA;AACA;AAEA;AACA;AACA;AAGA;AAMA;AAEA;AAQA;AAYA;AAEA;;;;;;;;;;;;;ACtHA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAMA;AAGA;AAEA;AAQA;AACA;AACA;AAEA;AAEA;;;;;;;;;;;;;;;;;;;;;;;;;;;ACzBA;AACA;AAEA;AAMA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAAA;AACA;AACA;AAAA;AACA;AACA;AACA;AACA;AACA;AAEA;AACA;;;;;A","sourceRoot":""}