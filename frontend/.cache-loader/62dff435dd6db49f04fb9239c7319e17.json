{"remainingRequest":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/thread-loader/dist/cjs.js??ref--5-1!/home/jinsoo/hypercloud-console5.0/frontend/node_modules/ts-loader/index.js??ref--5-2!/home/jinsoo/hypercloud-console5.0/frontend/packages/noobaa-storage-plugin/src/components/capacity-breakdown/capacity-breakdown-card.tsx","dependencies":[{"path":"/home/jinsoo/hypercloud-console5.0/frontend/packages/noobaa-storage-plugin/src/components/capacity-breakdown/capacity-breakdown-card.tsx","mtime":1616735742440},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/cache-loader/dist/cjs.js","mtime":1607306270906},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/thread-loader/dist/cjs.js","mtime":1607306283100},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/ts-loader/index.js","mtime":1607306283339}],"contextDependencies":[],"result":["import * as React from 'react';\nimport * as _ from 'lodash';\nimport { Dropdown, humanizeBinaryBytes, } from '@console/internal/components/utils';\nimport { referenceForModel } from '@console/internal/module/k8s';\nimport { withDashboardResources, } from '@console/internal/components/dashboard/with-dashboard-resources';\nimport DashboardCardHeader from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardHeader';\nimport DashboardCard from '@console/shared/src/components/dashboard/dashboard-card/DashboardCard';\nimport DashboardCardTitle from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardTitle';\nimport DashboardCardBody from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardBody';\nimport { getInstantVectorStats } from '@console/internal/components/graphs/utils';\nimport { SubscriptionModel } from '@console/operator-lifecycle-manager/src';\nimport { HeaderPrometheusViewLink } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/breakdown-header';\nimport { BreakdownCardBody } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/breakdown-body';\nimport { getStackChartStats } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/utils';\nimport { getOCSVersion } from '@console/ceph-storage-plugin/src/selectors';\nimport { CLUSTERWIDE, CLUSTERWIDE_TOOLTIP, Colors, } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/consts';\nimport { PROJECTS } from '../../constants/index';\nimport { breakdownQueryMap, CAPACITY_BREAKDOWN_QUERIES } from '../../queries';\nimport './capacity-breakdown-card.scss';\nimport { NooBaaBucketClassModel } from '../../models';\nconst SubscriptionResource = {\n    kind: referenceForModel(SubscriptionModel),\n    namespaced: false,\n    prop: 'subscription',\n    isList: true,\n};\nconst keys = Object.keys(breakdownQueryMap);\nconst dropdownOptions = _.zipObject(keys, keys);\nconst BreakdownCard = ({ watchK8sResource, stopWatchK8sResource, watchPrometheus, stopWatchPrometheusQuery, prometheusResults, resources, }) => {\n    const [metricType, setMetricType] = React.useState(PROJECTS);\n    const { queries, model, metric } = breakdownQueryMap[metricType];\n    React.useEffect(() => {\n        if (model.kind === NooBaaBucketClassModel.kind) {\n            watchK8sResource(SubscriptionResource);\n            return () => {\n                stopWatchK8sResource(SubscriptionResource);\n            };\n        }\n        return () => { };\n    }, [watchK8sResource, stopWatchK8sResource, model]);\n    const queryKeys = Object.keys(queries);\n    React.useEffect(() => {\n        queryKeys.forEach((q) => watchPrometheus(queries[q]));\n        return () => {\n            queryKeys.forEach((q) => stopWatchPrometheusQuery(queries[q]));\n        };\n    }, [watchPrometheus, stopWatchPrometheusQuery, metricType, queryKeys, queries]);\n    const subscription = _.get(resources, 'subscription');\n    const ocsVersion = getOCSVersion(subscription);\n    const results = queryKeys.map((key) => prometheusResults.getIn([queries[key], 'data']));\n    const queriesLoadError = queryKeys.some((q) => prometheusResults.getIn([queries[q], 'loadError']));\n    const queriesDataLoaded = queryKeys.some((q) => !prometheusResults.getIn([queries[q], 'data']));\n    const humanize = humanizeBinaryBytes;\n    const top5MetricsData = getInstantVectorStats(results[0], metric);\n    const top5MetricsStats = getStackChartStats(top5MetricsData, humanize);\n    const objectUsed = _.get(results[1], 'data.result[0].value[1]');\n    const link = `topk(20, (${CAPACITY_BREAKDOWN_QUERIES[queryKeys[0]]}))`;\n    const ind = top5MetricsStats.findIndex((v) => v.name === 'Others');\n    if (ind !== -1) {\n        top5MetricsStats[ind].name = CLUSTERWIDE;\n        top5MetricsStats[ind].link = CLUSTERWIDE_TOOLTIP;\n        top5MetricsStats[ind].color = Colors.OTHER;\n    }\n    return (React.createElement(DashboardCard, null,\n        React.createElement(DashboardCardHeader, null,\n            React.createElement(DashboardCardTitle, null, \"Capacity breakdown\"),\n            React.createElement(\"div\", { className: \"nb-capacity-breakdown-card__header\" },\n                React.createElement(HeaderPrometheusViewLink, { link: link }),\n                React.createElement(Dropdown, { items: dropdownOptions, onChange: setMetricType, selectedKey: metricType, title: metricType }))),\n        React.createElement(DashboardCardBody, { classname: \"nb-capacity-breakdown-card__body\" },\n            React.createElement(BreakdownCardBody, { isLoading: queriesDataLoaded, hasLoadError: queriesLoadError, top5MetricsStats: top5MetricsStats, capacityUsed: objectUsed, metricTotal: objectUsed, metricModel: model, humanize: humanize, ocsVersion: ocsVersion }))));\n};\nexport default withDashboardResources(BreakdownCard);\n",{"version":3,"file":"/home/jinsoo/hypercloud-console5.0/frontend/packages/noobaa-storage-plugin/src/components/capacity-breakdown/capacity-breakdown-card.tsx","sourceRoot":"","sources":["/home/jinsoo/hypercloud-console5.0/frontend/packages/noobaa-storage-plugin/src/components/capacity-breakdown/capacity-breakdown-card.tsx"],"names":[],"mappings":"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","sourcesContent":["import * as React from 'react';\nimport * as _ from 'lodash';\nimport {\n  Dropdown,\n  FirehoseResource,\n  FirehoseResult,\n  humanizeBinaryBytes,\n} from '@console/internal/components/utils';\nimport { referenceForModel } from '@console/internal/module/k8s';\nimport {\n  DashboardItemProps,\n  withDashboardResources,\n} from '@console/internal/components/dashboard/with-dashboard-resources';\nimport DashboardCardHeader from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardHeader';\nimport DashboardCard from '@console/shared/src/components/dashboard/dashboard-card/DashboardCard';\nimport DashboardCardTitle from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardTitle';\nimport DashboardCardBody from '@console/shared/src/components/dashboard/dashboard-card/DashboardCardBody';\nimport { getInstantVectorStats } from '@console/internal/components/graphs/utils';\nimport { SubscriptionModel } from '@console/operator-lifecycle-manager/src';\nimport { HeaderPrometheusViewLink } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/breakdown-header';\nimport { BreakdownCardBody } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/breakdown-body';\nimport { getStackChartStats } from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/utils';\nimport { getOCSVersion } from '@console/ceph-storage-plugin/src/selectors';\nimport {\n  CLUSTERWIDE,\n  CLUSTERWIDE_TOOLTIP,\n  Colors,\n} from '@console/ceph-storage-plugin/src/components/dashboard-page/storage-dashboard/breakdown-card/consts';\nimport { PROJECTS } from '../../constants/index';\nimport { breakdownQueryMap, CAPACITY_BREAKDOWN_QUERIES } from '../../queries';\nimport './capacity-breakdown-card.scss';\nimport { NooBaaBucketClassModel } from '../../models';\n\nconst SubscriptionResource: FirehoseResource = {\n  kind: referenceForModel(SubscriptionModel),\n  namespaced: false,\n  prop: 'subscription',\n  isList: true,\n};\n\nconst keys = Object.keys(breakdownQueryMap);\nconst dropdownOptions = _.zipObject(keys, keys);\n\nconst BreakdownCard: React.FC<DashboardItemProps> = ({\n  watchK8sResource,\n  stopWatchK8sResource,\n  watchPrometheus,\n  stopWatchPrometheusQuery,\n  prometheusResults,\n  resources,\n}) => {\n  const [metricType, setMetricType] = React.useState(PROJECTS);\n  const { queries, model, metric } = breakdownQueryMap[metricType];\n  React.useEffect(() => {\n    if (model.kind === NooBaaBucketClassModel.kind) {\n      watchK8sResource(SubscriptionResource);\n      return () => {\n        stopWatchK8sResource(SubscriptionResource);\n      };\n    }\n    return () => {};\n  }, [watchK8sResource, stopWatchK8sResource, model]);\n\n  const queryKeys = Object.keys(queries);\n\n  React.useEffect(() => {\n    queryKeys.forEach((q) => watchPrometheus(queries[q]));\n    return () => {\n      queryKeys.forEach((q) => stopWatchPrometheusQuery(queries[q]));\n    };\n  }, [watchPrometheus, stopWatchPrometheusQuery, metricType, queryKeys, queries]);\n\n  const subscription = _.get(resources, 'subscription') as FirehoseResult;\n  const ocsVersion = getOCSVersion(subscription);\n\n  const results = queryKeys.map((key) => prometheusResults.getIn([queries[key], 'data']));\n  const queriesLoadError = queryKeys.some((q) =>\n    prometheusResults.getIn([queries[q], 'loadError']),\n  );\n\n  const queriesDataLoaded = queryKeys.some((q) => !prometheusResults.getIn([queries[q], 'data']));\n\n  const humanize = humanizeBinaryBytes;\n  const top5MetricsData = getInstantVectorStats(results[0], metric);\n  const top5MetricsStats = getStackChartStats(top5MetricsData, humanize);\n  const objectUsed = _.get(results[1], 'data.result[0].value[1]');\n  const link = `topk(20, (${CAPACITY_BREAKDOWN_QUERIES[queryKeys[0]]}))`;\n\n  const ind = top5MetricsStats.findIndex((v) => v.name === 'Others');\n  if (ind !== -1) {\n    top5MetricsStats[ind].name = CLUSTERWIDE;\n    top5MetricsStats[ind].link = CLUSTERWIDE_TOOLTIP;\n    top5MetricsStats[ind].color = Colors.OTHER;\n  }\n\n  return (\n    <DashboardCard>\n      <DashboardCardHeader>\n        <DashboardCardTitle>Capacity breakdown</DashboardCardTitle>\n        <div className=\"nb-capacity-breakdown-card__header\">\n          <HeaderPrometheusViewLink link={link} />\n          <Dropdown\n            items={dropdownOptions}\n            onChange={setMetricType}\n            selectedKey={metricType}\n            title={metricType}\n          />\n        </div>\n      </DashboardCardHeader>\n      <DashboardCardBody classname=\"nb-capacity-breakdown-card__body\">\n        <BreakdownCardBody\n          isLoading={queriesDataLoaded}\n          hasLoadError={queriesLoadError}\n          top5MetricsStats={top5MetricsStats}\n          capacityUsed={objectUsed}\n          metricTotal={objectUsed}\n          metricModel={model}\n          humanize={humanize}\n          ocsVersion={ocsVersion}\n        />\n      </DashboardCardBody>\n    </DashboardCard>\n  );\n};\n\nexport default withDashboardResources(BreakdownCard);\n"]}]}