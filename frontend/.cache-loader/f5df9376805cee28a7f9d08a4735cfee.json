{"remainingRequest":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/thread-loader/dist/cjs.js??ref--5-1!/home/jinsoo/hypercloud-console5.0/frontend/node_modules/ts-loader/index.js??ref--5-2!/home/jinsoo/hypercloud-console5.0/frontend/packages/ceph-storage-plugin/src/components/modals/add-capacity-modal/add-capacity-modal.tsx","dependencies":[{"path":"/home/jinsoo/hypercloud-console5.0/frontend/packages/ceph-storage-plugin/src/components/modals/add-capacity-modal/add-capacity-modal.tsx","mtime":1616735742370},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/cache-loader/dist/cjs.js","mtime":1607306270906},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/thread-loader/dist/cjs.js","mtime":1607306283100},{"path":"/home/jinsoo/hypercloud-console5.0/frontend/node_modules/ts-loader/index.js","mtime":1607306283339}],"contextDependencies":[],"result":["import * as React from 'react';\nimport * as _ from 'lodash';\nimport * as classNames from 'classnames';\nimport { FieldLevelHelp, humanizeBinaryBytes } from '@console/internal/components/utils/index';\nimport { createModalLauncher, ModalBody, ModalSubmitFooter, ModalTitle, } from '@console/internal/components/factory';\nimport { usePrometheusPoll } from '@console/internal/components/graphs/prometheus-poll-hook';\nimport { k8sPatch } from '@console/internal/module/k8s';\nimport { PrometheusEndpoint } from '@console/internal/components/graphs/helpers';\nimport { getName } from '@console/shared';\nimport { OCSServiceModel } from '../../../models';\nimport { OSD_CAPACITY_SIZES } from '../../../utils/osd-size-dropdown';\nimport { CEPH_STORAGE_NAMESPACE, NO_PROVISIONER } from '../../../constants';\nimport { labelTooltip, storageClassTooltip } from '../../../constants/ocs-install';\nimport { CAPACITY_USAGE_QUERIES, StorageDashboardQuery } from '../../../constants/queries';\nimport { OCSStorageClassDropdown } from '../storage-class-dropdown';\nimport { PVsAvailableCapacity } from '../../ocs-install/pvs-available-capacity';\nimport './_add-capacity-modal.scss';\nconst getProvisionedCapacity = (value) => (value % 1 ? (value * 3).toFixed(2) : value * 3);\nexport const AddCapacityModal = (props) => {\n    var _a;\n    const { ocsConfig, close, cancel } = props;\n    const [response, loadError, loading] = usePrometheusPoll({\n        endpoint: PrometheusEndpoint.QUERY,\n        namespace: CEPH_STORAGE_NAMESPACE,\n        query: CAPACITY_USAGE_QUERIES[StorageDashboardQuery.CEPH_CAPACITY_USED],\n    });\n    const [storageClass, setStorageClass] = React.useState(null);\n    const [inProgress, setProgress] = React.useState(false);\n    const [errorMessage, setError] = React.useState('');\n    const osdSizeWithUnit = _.get(ocsConfig, 'spec.storageDeviceSets[0].dataPVCTemplate.spec.resources.requests.storage');\n    const presentCount = _.get(ocsConfig, 'spec.storageDeviceSets[0].count');\n    const capacity = _.get(response, 'data.result[0].value[1]');\n    const osdSizeWithoutUnit = (_a = OSD_CAPACITY_SIZES[osdSizeWithUnit]) === null || _a === void 0 ? void 0 : _a.size;\n    const provisionedCapacity = getProvisionedCapacity(osdSizeWithoutUnit);\n    let currentCapacity;\n    if (loading) {\n        currentCapacity = (React.createElement(\"div\", { className: \"skeleton-text ceph-add-capacity__current-capacity--loading\" }));\n    }\n    else if (loadError || !capacity || !presentCount || !osdSizeWithoutUnit) {\n        currentCapacity = React.createElement(\"div\", { className: \"text-muted\" }, \"Not available\");\n    }\n    else {\n        currentCapacity = (React.createElement(\"div\", { className: \"text-muted\" },\n            React.createElement(\"strong\", null, `${humanizeBinaryBytes(capacity / 3).string} / ${presentCount *\n                osdSizeWithoutUnit} TiB`)));\n    }\n    const submit = (event) => {\n        event.preventDefault();\n        setProgress(true);\n        const scName = getName(storageClass);\n        const patch = [\n            {\n                op: 'replace',\n                path: `/spec/storageDeviceSets/0/count`,\n                value: presentCount + 1,\n            },\n        ];\n        if (!scName) {\n            setError('No StorageClass selected');\n            setProgress(false);\n        }\n        else {\n            k8sPatch(OCSServiceModel, ocsConfig, patch)\n                .then(() => {\n                setProgress(false);\n                close();\n            })\n                .catch((err) => {\n                setError(err);\n                setProgress(false);\n            });\n        }\n    };\n    return (React.createElement(\"form\", { onSubmit: submit, className: \"modal-content modal-content--no-inner-scroll\" },\n        React.createElement(ModalTitle, null, \"Add Capacity\"),\n        React.createElement(ModalBody, null,\n            \"Adding capacity for \",\n            React.createElement(\"strong\", null, getName(ocsConfig)),\n            \", may increase your expenses.\",\n            React.createElement(\"div\", { className: \"ceph-add-capacity__modal\" },\n                React.createElement(\"div\", { className: classNames('ceph-add-capacity__sc-dropdown', {\n                        'ceph-add-capacity__sc-dropdown--margin': (storageClass === null || storageClass === void 0 ? void 0 : storageClass.provisioner) !== NO_PROVISIONER,\n                    }) },\n                    React.createElement(\"label\", { className: \"control-label\", htmlFor: \"storageClass\" },\n                        \"Storage Class\",\n                        React.createElement(FieldLevelHelp, null, storageClassTooltip)),\n                    React.createElement(OCSStorageClassDropdown, { onChange: setStorageClass })),\n                (storageClass === null || storageClass === void 0 ? void 0 : storageClass.provisioner) === NO_PROVISIONER ? (React.createElement(PVsAvailableCapacity, { replica: ocsConfig.spec.storageDeviceSets[0].replica, \"data-test-id\": \"ceph-add-capacity-pvs-available-capacity\", sc: storageClass })) : (React.createElement(\"div\", null,\n                    React.createElement(\"label\", { className: \"control-label\", htmlFor: \"requestSize\" },\n                        \"Raw Capacity\",\n                        React.createElement(FieldLevelHelp, null, labelTooltip)),\n                    React.createElement(\"div\", { className: \"ceph-add-capacity__form\" },\n                        React.createElement(\"input\", { className: classNames('pf-c-form-control', 'ceph-add-capacity__input'), type: \"number\", name: \"requestSize\", value: osdSizeWithoutUnit, required: true, disabled: true, \"data-test-id\": \"requestSize\" }),\n                        React.createElement(\"div\", { className: \"ceph-add-capacity__input--info-text\" },\n                            \"x 3 replicas = \",\n                            React.createElement(\"strong\", null,\n                                provisionedCapacity,\n                                \" TiB\"))),\n                    React.createElement(\"div\", { className: \"ceph-add-capacity__current-capacity\" },\n                        React.createElement(\"div\", { className: \"text-secondary ceph-add-capacity__current-capacity--text\" },\n                            React.createElement(\"strong\", null, \"Currently Used:\")),\n                        currentCapacity))))),\n        React.createElement(ModalSubmitFooter, { inProgress: inProgress, errorMessage: errorMessage, submitText: \"Add\", cancel: cancel })));\n};\nexport const addCapacityModal = createModalLauncher(AddCapacityModal);\n",{"version":3,"file":"/home/jinsoo/hypercloud-console5.0/frontend/packages/ceph-storage-plugin/src/components/modals/add-capacity-modal/add-capacity-modal.tsx","sourceRoot":"","sources":["/home/jinsoo/hypercloud-console5.0/frontend/packages/ceph-storage-plugin/src/components/modals/add-capacity-modal/add-capacity-modal.tsx"],"names":[],"mappings":"AAAA,OAAO,KAAK,KAAK,MAAM,OAAO,CAAC;AAC/B,OAAO,KAAK,CAAC,MAAM,QAAQ,CAAC;AAC5B,OAAO,KAAK,UAAU,MAAM,YAAY,CAAC;AACzC,OAAO,EAAE,cAAc,EAAE,mBAAmB,EAAE,MAAM,0CAA0C,CAAC;AAC/F,OAAO,EACL,mBAAmB,EACnB,SAAS,EACT,iBAAiB,EACjB,UAAU,GACX,MAAM,sCAAsC,CAAC;AAC9C,OAAO,EAAE,iBAAiB,EAAE,MAAM,0DAA0D,CAAC;AAC7F,OAAO,EAAE,QAAQ,EAA4B,MAAM,8BAA8B,CAAC;AAClF,OAAO,EAAE,kBAAkB,EAAE,MAAM,6CAA6C,CAAC;AACjF,OAAO,EAAE,OAAO,EAAE,MAAM,iBAAiB,CAAC;AAC1C,OAAO,EAAE,eAAe,EAAE,MAAM,iBAAiB,CAAC;AAClD,OAAO,EAAE,kBAAkB,EAAE,MAAM,kCAAkC,CAAC;AACtE,OAAO,EAAE,sBAAsB,EAAE,cAAc,EAAE,MAAM,oBAAoB,CAAC;AAC5E,OAAO,EAAE,YAAY,EAAE,mBAAmB,EAAE,MAAM,gCAAgC,CAAC;AACnF,OAAO,EAAE,sBAAsB,EAAE,qBAAqB,EAAE,MAAM,4BAA4B,CAAC;AAC3F,OAAO,EAAE,uBAAuB,EAAE,MAAM,2BAA2B,CAAC;AACpE,OAAO,EAAE,oBAAoB,EAAE,MAAM,0CAA0C,CAAC;AAChF,OAAO,4BAA4B,CAAC;AAEpC,MAAM,sBAAsB,GAAG,CAAC,KAAa,EAAE,EAAE,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,KAAK,GAAG,CAAC,CAAC,CAAC;AAEnG,MAAM,CAAC,MAAM,gBAAgB,GAAG,CAAC,KAA4B,EAAE,EAAE;;IAC/D,MAAM,EAAE,SAAS,EAAE,KAAK,EAAE,MAAM,EAAE,GAAG,KAAK,CAAC;IAE3C,MAAM,CAAC,QAAQ,EAAE,SAAS,EAAE,OAAO,CAAC,GAAG,iBAAiB,CAAC;QACvD,QAAQ,EAAE,kBAAkB,CAAC,KAAK;QAClC,SAAS,EAAE,sBAAsB;QACjC,KAAK,EAAE,sBAAsB,CAAC,qBAAqB,CAAC,kBAAkB,CAAC;KACxE,CAAC,CAAC;IACH,MAAM,CAAC,YAAY,EAAE,eAAe,CAAC,GAAG,KAAK,CAAC,QAAQ,CAA2B,IAAI,CAAC,CAAC;IACvF,MAAM,CAAC,UAAU,EAAE,WAAW,CAAC,GAAG,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;IACxD,MAAM,CAAC,YAAY,EAAE,QAAQ,CAAC,GAAG,KAAK,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;IAEpD,MAAM,eAAe,GAAG,CAAC,CAAC,GAAG,CAC3B,SAAS,EACT,2EAA2E,CAC5E,CAAC;IACF,MAAM,YAAY,GAAG,CAAC,CAAC,GAAG,CAAC,SAAS,EAAE,iCAAiC,CAAC,CAAC;IACzE,MAAM,QAAQ,GAAG,CAAC,CAAC,GAAG,CAAC,QAAQ,EAAE,yBAAyB,CAAC,CAAC;IAE5D,MAAM,kBAAkB,SAAG,kBAAkB,CAAC,eAAe,CAAC,0CAAE,IAAI,CAAC;IACrE,MAAM,mBAAmB,GAAG,sBAAsB,CAAC,kBAAkB,CAAC,CAAC;IAEvE,IAAI,eAAgC,CAAC;IAErC,IAAI,OAAO,EAAE;QACX,eAAe,GAAG,CAChB,6BAAK,SAAS,EAAC,4DAA4D,GAAG,CAC/E,CAAC;KACH;SAAM,IAAI,SAAS,IAAI,CAAC,QAAQ,IAAI,CAAC,YAAY,IAAI,CAAC,kBAAkB,EAAE;QACzE,eAAe,GAAG,6BAAK,SAAS,EAAC,YAAY,oBAAoB,CAAC;KACnE;SAAM;QACL,eAAe,GAAG,CAChB,6BAAK,SAAS,EAAC,YAAY;YACzB,oCAAS,GAAG,mBAAmB,CAAC,QAAQ,GAAG,CAAC,CAAC,CAAC,MAAM,MAAM,YAAY;gBACpE,kBAAkB,MAAM,CAAU,CAChC,CACP,CAAC;KACH;IAED,MAAM,MAAM,GAAG,CAAC,KAAmC,EAAE,EAAE;QACrD,KAAK,CAAC,cAAc,EAAE,CAAC;QACvB,WAAW,CAAC,IAAI,CAAC,CAAC;QAClB,MAAM,MAAM,GAAG,OAAO,CAAC,YAAY,CAAC,CAAC;QACrC,MAAM,KAAK,GAAG;YACZ;gBACE,EAAE,EAAE,SAAS;gBACb,IAAI,EAAE,iCAAiC;gBACvC,KAAK,EAAE,YAAY,GAAG,CAAC;aACxB;SACF,CAAC;QACF,IAAI,CAAC,MAAM,EAAE;YACX,QAAQ,CAAC,0BAA0B,CAAC,CAAC;YACrC,WAAW,CAAC,KAAK,CAAC,CAAC;SACpB;aAAM;YACL,QAAQ,CAAC,eAAe,EAAE,SAAS,EAAE,KAAK,CAAC;iBACxC,IAAI,CAAC,GAAG,EAAE;gBACT,WAAW,CAAC,KAAK,CAAC,CAAC;gBACnB,KAAK,EAAE,CAAC;YACV,CAAC,CAAC;iBACD,KAAK,CAAC,CAAC,GAAG,EAAE,EAAE;gBACb,QAAQ,CAAC,GAAG,CAAC,CAAC;gBACd,WAAW,CAAC,KAAK,CAAC,CAAC;YACrB,CAAC,CAAC,CAAC;SACN;IACH,CAAC,CAAC;IAEF,OAAO,CACL,8BAAM,QAAQ,EAAE,MAAM,EAAE,SAAS,EAAC,8CAA8C;QAC9E,oBAAC,UAAU,uBAA0B;QACrC,oBAAC,SAAS;;YACY,oCAAS,OAAO,CAAC,SAAS,CAAC,CAAU;;YACzD,6BAAK,SAAS,EAAC,0BAA0B;gBACvC,6BACE,SAAS,EAAE,UAAU,CAAC,gCAAgC,EAAE;wBACtD,wCAAwC,EACtC,CAAA,YAAY,aAAZ,YAAY,uBAAZ,YAAY,CAAE,WAAW,MAAK,cAAc;qBAC/C,CAAC;oBAEF,+BAAO,SAAS,EAAC,eAAe,EAAC,OAAO,EAAC,cAAc;;wBAErD,oBAAC,cAAc,QAAE,mBAAmB,CAAkB,CAChD;oBACR,oBAAC,uBAAuB,IAAC,QAAQ,EAAE,eAAe,GAAI,CAClD;gBACL,CAAA,YAAY,aAAZ,YAAY,uBAAZ,YAAY,CAAE,WAAW,MAAK,cAAc,CAAC,CAAC,CAAC,CAC9C,oBAAC,oBAAoB,IACnB,OAAO,EAAE,SAAS,CAAC,IAAI,CAAC,iBAAiB,CAAC,CAAC,CAAC,CAAC,OAAO,kBACvC,0CAA0C,EACvD,EAAE,EAAE,YAAY,GAChB,CACH,CAAC,CAAC,CAAC,CACF;oBACE,+BAAO,SAAS,EAAC,eAAe,EAAC,OAAO,EAAC,aAAa;;wBAEpD,oBAAC,cAAc,QAAE,YAAY,CAAkB,CACzC;oBACR,6BAAK,SAAS,EAAC,yBAAyB;wBACtC,+BACE,SAAS,EAAE,UAAU,CAAC,mBAAmB,EAAE,0BAA0B,CAAC,EACtE,IAAI,EAAC,QAAQ,EACb,IAAI,EAAC,aAAa,EAClB,KAAK,EAAE,kBAAkB,EACzB,QAAQ,QACR,QAAQ,wBACK,aAAa,GAC1B;wBACF,6BAAK,SAAS,EAAC,qCAAqC;;4BACnC;gCAAS,mBAAmB;uCAAc,CACrD,CACF;oBACN,6BAAK,SAAS,EAAC,qCAAqC;wBAClD,6BAAK,SAAS,EAAC,0DAA0D;4BACvE,sDAAgC,CAC5B;wBACL,eAAe,CACZ,CACF,CACP,CACG,CACI;QACZ,oBAAC,iBAAiB,IAChB,UAAU,EAAE,UAAU,EACtB,YAAY,EAAE,YAAY,EAC1B,UAAU,EAAC,KAAK,EAChB,MAAM,EAAE,MAAM,GACd,CACG,CACR,CAAC;AACJ,CAAC,CAAC;AASF,MAAM,CAAC,MAAM,gBAAgB,GAAG,mBAAmB,CAAC,gBAAgB,CAAC,CAAC","sourcesContent":["import * as React from 'react';\nimport * as _ from 'lodash';\nimport * as classNames from 'classnames';\nimport { FieldLevelHelp, humanizeBinaryBytes } from '@console/internal/components/utils/index';\nimport {\n  createModalLauncher,\n  ModalBody,\n  ModalSubmitFooter,\n  ModalTitle,\n} from '@console/internal/components/factory';\nimport { usePrometheusPoll } from '@console/internal/components/graphs/prometheus-poll-hook';\nimport { k8sPatch, StorageClassResourceKind } from '@console/internal/module/k8s';\nimport { PrometheusEndpoint } from '@console/internal/components/graphs/helpers';\nimport { getName } from '@console/shared';\nimport { OCSServiceModel } from '../../../models';\nimport { OSD_CAPACITY_SIZES } from '../../../utils/osd-size-dropdown';\nimport { CEPH_STORAGE_NAMESPACE, NO_PROVISIONER } from '../../../constants';\nimport { labelTooltip, storageClassTooltip } from '../../../constants/ocs-install';\nimport { CAPACITY_USAGE_QUERIES, StorageDashboardQuery } from '../../../constants/queries';\nimport { OCSStorageClassDropdown } from '../storage-class-dropdown';\nimport { PVsAvailableCapacity } from '../../ocs-install/pvs-available-capacity';\nimport './_add-capacity-modal.scss';\n\nconst getProvisionedCapacity = (value: number) => (value % 1 ? (value * 3).toFixed(2) : value * 3);\n\nexport const AddCapacityModal = (props: AddCapacityModalProps) => {\n  const { ocsConfig, close, cancel } = props;\n\n  const [response, loadError, loading] = usePrometheusPoll({\n    endpoint: PrometheusEndpoint.QUERY,\n    namespace: CEPH_STORAGE_NAMESPACE,\n    query: CAPACITY_USAGE_QUERIES[StorageDashboardQuery.CEPH_CAPACITY_USED],\n  });\n  const [storageClass, setStorageClass] = React.useState<StorageClassResourceKind>(null);\n  const [inProgress, setProgress] = React.useState(false);\n  const [errorMessage, setError] = React.useState('');\n\n  const osdSizeWithUnit = _.get(\n    ocsConfig,\n    'spec.storageDeviceSets[0].dataPVCTemplate.spec.resources.requests.storage',\n  );\n  const presentCount = _.get(ocsConfig, 'spec.storageDeviceSets[0].count');\n  const capacity = _.get(response, 'data.result[0].value[1]');\n\n  const osdSizeWithoutUnit = OSD_CAPACITY_SIZES[osdSizeWithUnit]?.size;\n  const provisionedCapacity = getProvisionedCapacity(osdSizeWithoutUnit);\n\n  let currentCapacity: React.ReactNode;\n\n  if (loading) {\n    currentCapacity = (\n      <div className=\"skeleton-text ceph-add-capacity__current-capacity--loading\" />\n    );\n  } else if (loadError || !capacity || !presentCount || !osdSizeWithoutUnit) {\n    currentCapacity = <div className=\"text-muted\">Not available</div>;\n  } else {\n    currentCapacity = (\n      <div className=\"text-muted\">\n        <strong>{`${humanizeBinaryBytes(capacity / 3).string} / ${presentCount *\n          osdSizeWithoutUnit} TiB`}</strong>\n      </div>\n    );\n  }\n\n  const submit = (event: React.FormEvent<EventTarget>) => {\n    event.preventDefault();\n    setProgress(true);\n    const scName = getName(storageClass);\n    const patch = [\n      {\n        op: 'replace',\n        path: `/spec/storageDeviceSets/0/count`,\n        value: presentCount + 1,\n      },\n    ];\n    if (!scName) {\n      setError('No StorageClass selected');\n      setProgress(false);\n    } else {\n      k8sPatch(OCSServiceModel, ocsConfig, patch)\n        .then(() => {\n          setProgress(false);\n          close();\n        })\n        .catch((err) => {\n          setError(err);\n          setProgress(false);\n        });\n    }\n  };\n\n  return (\n    <form onSubmit={submit} className=\"modal-content modal-content--no-inner-scroll\">\n      <ModalTitle>Add Capacity</ModalTitle>\n      <ModalBody>\n        Adding capacity for <strong>{getName(ocsConfig)}</strong>, may increase your expenses.\n        <div className=\"ceph-add-capacity__modal\">\n          <div\n            className={classNames('ceph-add-capacity__sc-dropdown', {\n              'ceph-add-capacity__sc-dropdown--margin':\n                storageClass?.provisioner !== NO_PROVISIONER,\n            })}\n          >\n            <label className=\"control-label\" htmlFor=\"storageClass\">\n              Storage Class\n              <FieldLevelHelp>{storageClassTooltip}</FieldLevelHelp>\n            </label>\n            <OCSStorageClassDropdown onChange={setStorageClass} />\n          </div>\n          {storageClass?.provisioner === NO_PROVISIONER ? (\n            <PVsAvailableCapacity\n              replica={ocsConfig.spec.storageDeviceSets[0].replica}\n              data-test-id=\"ceph-add-capacity-pvs-available-capacity\"\n              sc={storageClass}\n            />\n          ) : (\n            <div>\n              <label className=\"control-label\" htmlFor=\"requestSize\">\n                Raw Capacity\n                <FieldLevelHelp>{labelTooltip}</FieldLevelHelp>\n              </label>\n              <div className=\"ceph-add-capacity__form\">\n                <input\n                  className={classNames('pf-c-form-control', 'ceph-add-capacity__input')}\n                  type=\"number\"\n                  name=\"requestSize\"\n                  value={osdSizeWithoutUnit}\n                  required\n                  disabled\n                  data-test-id=\"requestSize\"\n                />\n                <div className=\"ceph-add-capacity__input--info-text\">\n                  x 3 replicas = <strong>{provisionedCapacity} TiB</strong>\n                </div>\n              </div>\n              <div className=\"ceph-add-capacity__current-capacity\">\n                <div className=\"text-secondary ceph-add-capacity__current-capacity--text\">\n                  <strong>Currently Used:</strong>\n                </div>\n                {currentCapacity}\n              </div>\n            </div>\n          )}\n        </div>\n      </ModalBody>\n      <ModalSubmitFooter\n        inProgress={inProgress}\n        errorMessage={errorMessage}\n        submitText=\"Add\"\n        cancel={cancel}\n      />\n    </form>\n  );\n};\n\nexport type AddCapacityModalProps = {\n  kind?: any;\n  ocsConfig?: any;\n  cancel?: () => void;\n  close?: () => void;\n};\n\nexport const addCapacityModal = createModalLauncher(AddCapacityModal);\n"]}]}